// === IMPORT DEPENDENCIES ===
const express = require('express');                    // Framework web cho Node.js
const { createProxyMiddleware } = require('http-proxy-middleware'); // Middleware Ä‘á»ƒ proxy requests
const cors = require('cors');                          // Middleware xá»­ lÃ½ CORS (Cross-Origin Resource Sharing)
const path = require('path');                          // Module Ä‘á»ƒ xá»­ lÃ½ Ä‘Æ°á»ng dáº«n file

// === APP CONFIGURATION ===
const app = express();                                 // Táº¡o instance Express app
const PORT = process.env.API_GATEWAY_PORT || 3000;    // Cá»•ng cháº¡y server (env variable hoáº·c 3000)
const INSTANCE_ID = process.env.INSTANCE_ID || 'api-gateway-default'; // ID instance cho load balancing

// === GLOBAL MIDDLEWARE ===
app.use(cors());                                       // Báº­t CORS cho táº¥t cáº£ routes

// === DEBUG MIDDLEWARE ===
app.use((req, res, next) => {                         // Middleware debug - cháº¡y Ä‘áº§u tiÃªn
    console.log(`ğŸŒ [${INSTANCE_ID}] INCOMING: ${req.method} ${req.originalUrl}`); // Log má»i request Ä‘áº¿n
    next();                                            // Chuyá»ƒn Ä‘áº¿n middleware tiáº¿p theo
});

// === BODY PARSING MIDDLEWARE ===
app.use(express.json({ limit: '10mb' }));             // Parse JSON body, giá»›i háº¡n 10MB
app.use(express.urlencoded({ extended: true, limit: '10mb' })); // Parse URL-encoded data

// === ROUTE-SPECIFIC DEBUG MIDDLEWARE ===
app.use('/api/users', (req, res, next) => {          // Debug cho user routes
    console.log(`ğŸ¯ [${INSTANCE_ID}] Matched /api/users route: ${req.method} ${req.originalUrl}`);
    console.log(`ğŸ¯ [${INSTANCE_ID}] Path after /api/users: ${req.url}`); // Path sau khi bá» prefix
    next();
});

app.use('/services/user', (req, res, next) => {      // Debug cho user service routes
    console.log(`ğŸ¯ [${INSTANCE_ID}] Matched /services/user route: ${req.method} ${req.originalUrl}`);
    console.log(`ğŸ¯ [${INSTANCE_ID}] Path after /services/user: ${req.url}`);
    next();
});

// === REQUEST LOGGING MIDDLEWARE ===
app.use((req, res, next) => {                        // Middleware log chi tiáº¿t request
    const startTime = Date.now();                     // Thá»i gian báº¯t Ä‘áº§u request
    req.startTime = startTime;                        // LÆ°u start time vÃ o request object

    // Log thÃ´ng tin request
    console.log(`ğŸšª [${INSTANCE_ID}] ${new Date().toISOString()} - ${req.method} ${req.path}`);
    console.log(`ğŸ“¦ [${INSTANCE_ID}] Request body:`, req.body);     // Log request body
    console.log(`ğŸ›£ï¸  [${INSTANCE_ID}] Original URL: ${req.originalUrl}`); // Log URL gá»‘c
    console.log(`ğŸ“ [${INSTANCE_ID}] Headers:`, req.headers);      // Log táº¥t cáº£ headers

    // Log response khi hoÃ n thÃ nh
    res.on('finish', () => {                          // Event listener khi response xong
        const duration = Date.now() - startTime;      // TÃ­nh thá»i gian xá»­ lÃ½
        console.log(`ğŸ“¤ [${INSTANCE_ID}] ${req.method} ${req.path} - ${res.statusCode} (${duration}ms)`);
    });

    next();
});

// === STATIC FILES (COMMENTED OUT) ===
// app.use('/assets', express.static(path.join(__dirname, 'assets'))); // Serve static assets
// app.use('/UI', express.static(path.join(__dirname, 'UI')));         // Serve UI files

// === HEALTH CHECK ENDPOINT ===
app.get('/health', (req, res) => {                   // Health check route
    res.status(200).json({                            // Tráº£ vá» status 200 vá»›i thÃ´ng tin
        status: 'OK',                                 // Tráº¡ng thÃ¡i service
        service: 'api-gateway',                       // TÃªn service
        instance: INSTANCE_ID,                        // ID cá»§a instance
        timestamp: new Date().toISOString(),          // Thá»i gian hiá»‡n táº¡i
        uptime: process.uptime(),                     // Thá»i gian cháº¡y cá»§a process
        services: {                                   // Danh sÃ¡ch services backend
            userService: process.env.USER_SERVICE_URL || 'http://user-service:3001',
            roomService: process.env.ROOM_SERVICE_URL || 'http://room-service:3002',
            bookingService: process.env.BOOKING_SERVICE_URL || 'http://booking-service:3003'
        },
        architecture: 'nginx-to-gateway-to-services'  // Kiáº¿n trÃºc há»‡ thá»‘ng
    });
});

// === USER SERVICE PROXY CONFIGURATION ===
const userServiceProxy = createProxyMiddleware({      // Táº¡o proxy cho user service
    target: process.env.USER_SERVICE_URL || 'http://user-service:3001', // URL Ä‘Ã­ch
    changeOrigin: true,                               // Thay Ä‘á»•i origin header
    timeout: 30000,                                   // Timeout 30 giÃ¢y
    proxyTimeout: 30000,                              // Proxy timeout 30 giÃ¢y
    pathRewrite: {                                    // Rewrite Ä‘Æ°á»ng dáº«n
        '^/services/user': '',                        // Bá» /services/user prefix
        '^/api/users': '',                            // Bá» /api/users prefix
    },
    onProxyReq: (proxyReq, req, res) => {            // Callback khi proxy request
        console.log(`ğŸ”€ [${INSTANCE_ID}] User Service: ${req.method} ${req.originalUrl} â†’ ${proxyReq.getHeader('host')}${proxyReq.path}`);

        // Forward essential headers
        if (req.get('content-type')) {                // Chuyá»ƒn tiáº¿p Content-Type header
            proxyReq.setHeader('content-type', req.get('content-type'));
        }
        if (req.get('authorization')) {               // Chuyá»ƒn tiáº¿p Authorization header
            proxyReq.setHeader('authorization', req.get('authorization'));
        }

        // Add tracing headers
        proxyReq.setHeader('X-Gateway-Instance', INSTANCE_ID);           // Header trace gateway
        proxyReq.setHeader('X-Request-ID', req.get('X-Request-ID') || `req-${Date.now()}`); // Header trace request

        // Handle request body for POST/PUT requests
        if (req.body && (req.method === 'POST' || req.method === 'PUT' || req.method === 'PATCH')) {
            const bodyData = JSON.stringify(req.body); // Convert body thÃ nh JSON string
            console.log(`ğŸ“¦ [${INSTANCE_ID}] Forwarding body:`, bodyData);

            proxyReq.setHeader('Content-Type', 'application/json');      // Set Content-Type
            proxyReq.setHeader('Content-Length', Buffer.byteLength(bodyData)); // Set Content-Length
            proxyReq.write(bodyData);                 // Ghi body data vÃ o proxy request
        }
    },
    onProxyRes: (proxyRes, req, res) => {            // Callback khi nháº­n response tá»« service
        console.log(`âœ… [${INSTANCE_ID}] User Service Response: ${proxyRes.statusCode} for ${req.method} ${req.originalUrl} (${Date.now() - req.startTime}ms)`);

        // Add response headers for debugging
        res.setHeader('X-Proxied-By', `${INSTANCE_ID}-user-service`);    // Header trace proxy
        res.setHeader('X-Service-Response-Time', Date.now() - req.startTime); // Header response time

        if (proxyRes.statusCode >= 400) {             // Log náº¿u cÃ³ lá»—i
            console.log(`âŒ [${INSTANCE_ID}] User Service Error: Status ${proxyRes.statusCode}`);
        }
    },
    onError: (err, req, res) => {                    // Callback khi cÃ³ lá»—i proxy
        console.error(`ğŸ’¥ [${INSTANCE_ID}] User Service Proxy Error:`, err.message);
        if (!res.headersSent) {                       // Náº¿u response chÆ°a Ä‘Æ°á»£c gá»­i
            res.status(503).json({                    // Tráº£ vá» lá»—i 503 Service Unavailable
                success: false,
                message: 'User service temporarily unavailable',
                error: err.code || err.message,
                gateway: INSTANCE_ID
            });
        }
    }
});

// === ROOM SERVICE PROXY CONFIGURATION ===
const roomServiceProxy = createProxyMiddleware({      // TÆ°Æ¡ng tá»± user service proxy
    target: process.env.ROOM_SERVICE_URL || 'http://room-service:3002',
    changeOrigin: true,
    timeout: 30000,
    proxyTimeout: 30000,
    pathRewrite: {
        '^/services/room': '/rooms',                  // Rewrite thÃ nh /rooms
        '^/api/rooms': '/rooms',
    },
    onProxyReq: (proxyReq, req, res) => {
        console.log(`ğŸ”€ [${INSTANCE_ID}] Room Service: ${req.method} ${req.originalUrl} â†’ ${proxyReq.getHeader('host')}${proxyReq.path}`);

        if (req.get('content-type')) {
            proxyReq.setHeader('content-type', req.get('content-type'));
        }
        if (req.get('authorization')) {
            proxyReq.setHeader('authorization', req.get('authorization'));
        }

        proxyReq.setHeader('X-Gateway-Instance', INSTANCE_ID);
        proxyReq.setHeader('X-Request-ID', req.get('X-Request-ID') || `req-${Date.now()}`);

        if (req.body && (req.method === 'POST' || req.method === 'PUT' || req.method === 'PATCH')) {
            const bodyData = JSON.stringify(req.body);
            proxyReq.setHeader('Content-Type', 'application/json');
            proxyReq.setHeader('Content-Length', Buffer.byteLength(bodyData));
            proxyReq.write(bodyData);
        }
    },
    onProxyRes: (proxyRes, req, res) => {
        console.log(`âœ… [${INSTANCE_ID}] Room Service Response: ${proxyRes.statusCode} for ${req.method} ${req.originalUrl} (${Date.now() - req.startTime}ms)`);

        res.setHeader('X-Proxied-By', `${INSTANCE_ID}-room-service`);
        res.setHeader('X-Service-Response-Time', Date.now() - req.startTime);
    },
    onError: (err, req, res) => {
        console.error(`ğŸ’¥ [${INSTANCE_ID}] Room Service Proxy Error:`, err.message);
        if (!res.headersSent) {
            res.status(503).json({
                success: false,
                message: 'Room service unavailable',
                error: err.code || err.message,
                gateway: INSTANCE_ID
            });
        }
    }
});

// === BOOKING SERVICE PROXY CONFIGURATION ===
const bookingServiceProxy = createProxyMiddleware({   // TÆ°Æ¡ng tá»± cÃ¡c proxy trÃªn
    target: process.env.BOOKING_SERVICE_URL || 'http://booking-service:3003',
    changeOrigin: true,
    timeout: 30000,
    proxyTimeout: 30000,
    pathRewrite: {
        '^/bookings': '/bookings',                    // Giá»¯ nguyÃªn path /bookings
    },
    onProxyReq: (proxyReq, req, res) => {
        console.log(`ğŸ”€ [${INSTANCE_ID}] Booking Service: ${req.method} ${req.originalUrl} â†’ ${proxyReq.getHeader('host')}${proxyReq.path}`);

        if (req.get('content-type')) {
            proxyReq.setHeader('content-type', req.get('content-type'));
        }
        if (req.get('authorization')) {
            proxyReq.setHeader('authorization', req.get('authorization'));
        }

        proxyReq.setHeader('X-Gateway-Instance', INSTANCE_ID);
        proxyReq.setHeader('X-Request-ID', req.get('X-Request-ID') || `req-${Date.now()}`);

        if (req.body && (req.method === 'POST' || req.method === 'PUT' || req.method === 'PATCH')) {
            const bodyData = JSON.stringify(req.body);
            proxyReq.setHeader('Content-Type', 'application/json');
            proxyReq.setHeader('Content-Length', Buffer.byteLength(bodyData));
            proxyReq.write(bodyData);
        }
    },
    onProxyRes: (proxyRes, req, res) => {
        console.log(`âœ… [${INSTANCE_ID}] Booking Service Response: ${proxyRes.statusCode} for ${req.method} ${req.originalUrl} (${Date.now() - req.startTime}ms)`);

        res.setHeader('X-Proxied-By', `${INSTANCE_ID}-booking-service`);
        res.setHeader('X-Service-Response-Time', Date.now() - req.startTime);
    },
    onError: (err, req, res) => {
        console.error(`ğŸ’¥ [${INSTANCE_ID}] Booking Service Proxy Error:`, err.message);
        if (!res.headersSent) {
            res.status(503).json({
                success: false,
                message: 'Booking service unavailable',
                error: err.code || err.message,
                gateway: INSTANCE_ID
            });
        }
    }
});

// === APPLY PROXY MIDDLEWARE ===
app.use('/services/user', userServiceProxy);          // Ãp dá»¥ng user proxy cho /services/user
app.use('/api/users', userServiceProxy);              // Ãp dá»¥ng user proxy cho /api/users
app.use('/services/room', roomServiceProxy);          // Ãp dá»¥ng room proxy cho /services/room
app.use('/api/rooms', roomServiceProxy);              // Ãp dá»¥ng room proxy cho /api/rooms
app.use('/bookings', bookingServiceProxy);            // Ãp dá»¥ng booking proxy cho /bookings
app.use('/api/bookings', bookingServiceProxy);        // Ãp dá»¥ng booking proxy cho /api/bookings

// === GATEWAY STATS ENDPOINT ===
app.get('/gateway-stats', (req, res) => {            // Endpoint thá»‘ng kÃª gateway
    res.json({
        gateway: {
            instance: INSTANCE_ID,                     // ID instance
            uptime: process.uptime(),                  // Thá»i gian cháº¡y
            memory: process.memoryUsage(),             // ThÃ´ng tin memory
            timestamp: new Date().toISOString()       // Thá»i gian hiá»‡n táº¡i
        },
        routing: {                                     // Báº£ng routing
            '/services/user/*': process.env.USER_SERVICE_URL || 'http://user-service:3001',
            '/api/users/*': process.env.USER_SERVICE_URL || 'http://user-service:3001',
            '/services/room/*': process.env.ROOM_SERVICE_URL || 'http://room-service:3002',
            '/api/rooms/*': process.env.ROOM_SERVICE_URL || 'http://room-service:3002',
            '/bookings/*': process.env.BOOKING_SERVICE_URL || 'http://booking-service:3003',
            '/api/bookings/*': process.env.BOOKING_SERVICE_URL || 'http://booking-service:3003'
        },
        architecture: 'nginx â†’ api-gateway â†’ microservices' // Kiáº¿n trÃºc há»‡ thá»‘ng
    });
});

// === DEFAULT ROUTE ===
app.get('/', (req, res) => {                         // Route máº·c Ä‘á»‹nh
    res.json({
        message: 'Room Booking API Gateway',          // ThÃ´ng Ä‘iá»‡p chÃ o má»«ng
        instance: INSTANCE_ID,                        // ID instance
        version: '2.0.0',                            // Version API
        architecture: 'nginx â†’ api-gateway â†’ microservices', // Kiáº¿n trÃºc
        endpoints: {                                  // Danh sÃ¡ch endpoints
            health: '/health',
            stats: '/gateway-stats',
            userService: '/services/user/* OR /api/users/*',
            roomService: '/services/room/* OR /api/rooms/*',
            bookingService: '/bookings/* OR /api/bookings/*'
        },
        documentation: {                              // API documentation
            users: {
                register: 'POST /api/users/register',
                login: 'POST /api/users/login',
                profile: 'GET /api/users/profile'
            },
            rooms: {
                list: 'GET /api/rooms',
                create: 'POST /api/rooms',
                details: 'GET /api/rooms/:id',
                update: 'PUT /api/rooms/:id',
                delete: 'DELETE /api/rooms/:id'
            },
            bookings: {
                list: 'GET /api/bookings',
                create: 'POST /api/bookings',
                details: 'GET /api/bookings/:id',
                update: 'PUT /api/bookings/:id',
                delete: 'DELETE /api/bookings/:id'
            }
        }
    });
});

// === CATCH-ALL ROUTE ===
app.use('*', (req, res) => {                         // Route báº¯t táº¥t cáº£ requests khÃ´ng match
    console.log(`â“ [${INSTANCE_ID}] Unknown route: ${req.method} ${req.originalUrl}`);
    res.status(404).json({                            // Tráº£ vá» 404 Not Found
        success: false,
        message: `Route not found: ${req.method} ${req.originalUrl}`,
        gateway: INSTANCE_ID,
        availableRoutes: [                            // Danh sÃ¡ch routes cÃ³ sáºµn
            '/health',
            '/gateway-stats',
            '/api/users/*',
            '/api/rooms/*',
            '/api/bookings/*',
            '/services/user/*',
            '/services/room/*'
        ]
    });
});

// === START SERVER ===
app.listen(PORT, () => {                             // Khá»Ÿi Ä‘á»™ng server
    console.log(`ğŸšª API Gateway [${INSTANCE_ID}] running on port ${PORT}`);
    console.log(`ğŸ”— Services Configuration:`);        // Log cáº¥u hÃ¬nh services
    console.log(`   User Service: ${process.env.USER_SERVICE_URL || 'http://user-service:3001'}`);
    console.log(`   Room Service: ${process.env.ROOM_SERVICE_URL || 'http://room-service:3002'}`);
    console.log(`   Booking Service: ${process.env.BOOKING_SERVICE_URL || 'http://booking-service:3003'}`);
    console.log(`ğŸ—ï¸  Architecture: NGINX â†’ API Gateway â†’ Microservices`);
});

module.exports = app;                                 // Export app Ä‘á»ƒ testing